<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>好想租屋｜個人資料</title>
  <link rel="icon" type="image/png" href="logo.jpg" />
  <style>
    body {
      margin: 0;
      font-family: "Noto Sans TC", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", Roboto, Arial, sans-serif;
      background: #f4f6f9;
      color: #111827;
    }

    header {
      background: #047857;
      color: #fff;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header h1 {
      margin: 0;
      font-size: 18px;
    }

    header a {
      color: #bbf7d0;
      font-size: 13px;
      text-decoration: none;
      margin-left: 12px;
    }

    main {
      max-width: 720px;
      margin: 24px auto 40px;
      padding: 0 16px;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 18px 18px 16px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.06);
      margin-bottom: 20px;
    }

    .card h2 {
      margin: 0 0 12px;
      font-size: 18px;
    }

    label {
      display: block;
      margin-top: 10px;
      margin-bottom: 4px;
      font-size: 14px;
      color: #4b5563;
    }

    input, select, textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      box-sizing: border-box;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    button {
      margin-top: 16px;
      padding: 10px 20px;
      border-radius: 999px;
      border: none;
      background: #047857;
      color: #fff;
      font-size: 15px;
      cursor: pointer;
    }

    button:hover {
      opacity: 0.9;
    }

    #msg {
      margin-top: 10px;
      font-size: 13px;
      color: #374151;
    }

    .role-hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <header>
    <h1>好想租屋｜個人資料</h1>
    <div>
      <a href="account.html">回會員中心</a>
      <a href="login.html">登入頁</a>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>基本資料</h2>

      <label for="displayName">姓名 / 顯示名稱</label>
      <input id="displayName" placeholder="請輸入姓名">

      <label for="email">Email（登入用，不可修改）</label>
      <input id="email" disabled>

      <label for="phone">手機號碼</label>
      <input id="phone" placeholder="請輸入手機號碼">

      <label for="city">服務城市</label>
      <select id="city">
        <option value="">請選擇</option>
        <option value="高雄市">高雄市</option>
        <option value="台南市">台南市（大臺南）</option>
        <option value="其他">其他（暫不服務）</option>
      </select>

      <label for="role">目前身分</label>
      <select id="role">
        <option value="tenant">一般租客 / 房客</option>
        <option value="landlord">屋主（名下有物件）</option>
        <option value="agent">業務 / 代管專員</option>
        <option value="admin">公司管理者</option>
      </select>
      <div class="role-hint">
        ※ 之後可以在後台由公司調整身分，一般租客不用改。
      </div>

      <label for="notes">備註 / 特別需求（選填）</label>
      <textarea id="notes" placeholder="例如：希望近捷運、有電梯、可養寵物…"></textarea>

      <button id="save-profile">儲存資料</button>
      <p id="msg">載入中…</p>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ✅ 跟 login.html 一樣的 Firebase 設定
    const firebaseConfig = {
      apiKey: "AIzaSyDap-cGTy0IKomhHbVQKB3Y-JLZk1pK42w",
      authDomain: "smilehouse-a68bc.firebaseapp.com",
      projectId: "smilehouse-a68bc",
      storageBucket: "smilehouse-a68bc.firebasestorage.app",
      messagingSenderId: "542151591313",
      appId: "1:542151591313:web:e10b10e0b5a083fe75c630",
      measurementId: "G-0Q5LFE84ER"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const displayNameEl = document.getElementById("displayName");
    const emailEl = document.getElementById("email");
    const phoneEl = document.getElementById("phone");
    const cityEl = document.getElementById("city");
    const roleEl = document.getElementById("role");
    const notesEl = document.getElementById("notes");
    const msgEl = document.getElementById("msg");
    const saveBtn = document.getElementById("save-profile");

    function setMsg(text) {
      if (msgEl) msgEl.textContent = text;
    }

    // 監聽登入狀態，讀取 users/{uid} 資料
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // 未登入直接回登入頁
        window.location.href = "login.html";
        return;
      }

      setMsg("載入資料中…");

      try {
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);

        const data = snap.exists() ? snap.data() : {};

        const displayName = data.displayName || user.displayName || "";
        const email = data.email || user.email || "";
        const phone = data.phone || "";
        const city = data.city || "";
        const role = data.role || "tenant";
        const notes = data.notes || "";

        displayNameEl.value = displayName;
        emailEl.value = email;
        phoneEl.value = phone;
        cityEl.value = city;
        roleEl.value = role;
        notesEl.value = notes;

        setMsg("資料已載入，請確認或修改後儲存。");
      } catch (err) {
        console.error("[PROFILE LOAD ERROR]", err);
        setMsg("載入資料發生錯誤：" + (err.message || ""));
      }
    });

    // 儲存資料
    if (saveBtn) {
      saveBtn.addEventListener("click", async () => {
        const user = auth.currentUser;
        if (!user) {
          window.location.href = "login.html";
          return;
        }

        const displayName = displayNameEl.value.trim();
        const phone = phoneEl.value.trim();
        const city = cityEl.value;
        const role = roleEl.value;
        const notes = notesEl.value.trim();
        const email = user.email || "";

        if (!displayName) {
          setMsg("請填寫姓名 / 顯示名稱。");
          return;
        }

        setMsg("儲存中，請稍候…");

        try {
          const ref = doc(db, "users", user.uid);
          await setDoc(ref, {
            displayName,
            phone,
            city,
            role,
            notes,
            email,
            updatedAt: serverTimestamp(),
            createdAt: serverTimestamp()
          }, { merge: true });

          // 更新 Auth 上的 displayName
          await updateProfile(user, { displayName });

          setMsg("已儲存 ✔︎");
        } catch (err) {
          console.error("[PROFILE SAVE ERROR]", err);
          setMsg("儲存失敗：" + (err.message || ""));
        }
      });
    }
  </script>
</body>
</html>