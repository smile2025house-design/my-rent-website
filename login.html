<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>好租租屋｜登入</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="base.css" />
</head>
<body class="auth-page">
  <div class="auth-box">
    <div class="auth-logo">
      租
    </div>
    <div class="auth-title">開始使用 好租租屋</div>
    <div class="auth-subtitle">
      請先登入後再進入後台。若只想逛逛，也可直接回首頁。
    </div>

    <button id="btn-google" class="btn btn-primary auth-btn">
      使用 Google 登入
    </button>
    <button id="btn-line" class="btn btn-outline auth-btn">
      使用 LINE 登入
    </button>

    <button id="btn-email-toggle" class="btn auth-btn">
      使用電子郵件登入
    </button>

    <div id="email-section" style="display:none; margin-top:8px; text-align:left;">
      <div class="form-group">
        <label class="form-label">Email</label>
        <input id="email-input" type="email" class="form-input" placeholder="請輸入 Email" />
      </div>
      <div class="form-group">
        <label class="form-label">密碼（至少 6 字）</label>
        <input id="password-input" type="password" class="form-input" placeholder="請輸入密碼" />
      </div>
      <button id="btn-email-login" class="btn btn-primary auth-btn">
        Email 登入 / 註冊
      </button>
    </div>

    <button id="btn-guest" class="btn auth-btn" style="margin-top:10px;">
      以訪客身分繼續瀏覽
    </button>

    <div class="auth-status" id="status"></div>

    <div style="margin-top:10px; font-size:12px;">
      ← 回到 <a href="home.html">首頁</a> 繼續瀏覽
    </div>
  </div>

  <script type="module">
    import {
      auth,
      googleProvider,
      lineProvider,
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult,
      signInAnonymously,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword
    } from "./firebase.js";

    const AFTER_LOGIN_DEFAULT = "home.html";

    const params = new URLSearchParams(window.location.search);
    const targetRole = params.get("role") || "member";

    function getAfterLoginUrl() {
      switch (targetRole) {
        case "owner": return "owner.html";
        case "company": return "company.html";
        case "agent": return "agent.html";
        case "member":
        default:
          return "profile.html";
      }
    }

    const statusEl = document.getElementById("status");
    const btnGoogle = document.getElementById("btn-google");
    const btnLine = document.getElementById("btn-line");
    const btnGuest = document.getElementById("btn-guest");
    const btnEmailToggle = document.getElementById("btn-email-toggle");
    const emailSection = document.getElementById("email-section");
    const btnEmailLogin = document.getElementById("btn-email-login");
    const emailInput = document.getElementById("email-input");
    const passwordInput = document.getElementById("password-input");

    function setStatus(msg) {
      if (statusEl) statusEl.textContent = msg;
    }

    // 處理 LINE redirect 結果（手機版）
    getRedirectResult(auth)
      .then(result => {
        if (result && result.user) {
          setStatus("LINE 登入成功，導向中...");
          window.location.href = getAfterLoginUrl();
        }
      })
      .catch(err => {
        if (err.code !== "auth/no-auth-event") {
          console.error("LINE redirect error", err);
        }
      });

    async function signInWithProviderPopup(providerName) {
      try {
        if (providerName === "Google") {
          setStatus("使用 Google 登入中...");
          const { signInWithPopup } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
          await signInWithPopup(auth, googleProvider);
        }
      } catch (err) {
        console.error(providerName + " LOGIN ERROR", err);
        setStatus(providerName + " 登入失敗：" + (err.message || ""));
        return;
      }
      setStatus("登入成功，導向中...");
      window.location.href = getAfterLoginUrl();
    }

    // Google 登入
    if (btnGoogle) {
      btnGoogle.addEventListener("click", () => signInWithProviderPopup("Google"));
    }

    // LINE 登入（使用 redirect，較適合手機環境）
    if (btnLine) {
      btnLine.addEventListener("click", async () => {
        try {
          setStatus("正在前往 LINE 登入...");
          await signInWithRedirect(auth, lineProvider);
        } catch (err) {
          console.error("LINE LOGIN ERROR", err);
          setStatus("LINE 登入失敗：" + (err.message || ""));
        }
      });
    }

    // 訪客登入
    if (btnGuest) {
      btnGuest.addEventListener("click", async () => {
        try {
          setStatus("以訪客身分登入中...");
          await signInAnonymously(auth);
          window.location.href = AFTER_LOGIN_DEFAULT;
        } catch (err) {
          console.error("[GUEST ERROR]", err);
          setStatus("訪客登入失敗：" + (err.message || ""));
        }
      });
    }

    // Email 區塊顯示 / 隱藏
    if (btnEmailToggle && emailSection) {
      btnEmailToggle.addEventListener("click", () => {
        const visible = emailSection.style.display !== "none";
        emailSection.style.display = visible ? "none" : "block";
      });
    }

    // Email 登入 / 註冊
    if (btnEmailLogin && emailInput && passwordInput) {
      btnEmailLogin.addEventListener("click", async () => {
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();

        if (!email || !password) {
          setStatus("請輸入 Email 與密碼。");
          return;
        }
        if (password.length < 6) {
          setStatus("密碼至少 6 個字。");
          return;
        }

        try {
          setStatus("Email 登入中...");
          await signInWithEmailAndPassword(auth, email, password);
          setStatus("登入成功！");
          window.location.href = getAfterLoginUrl();
        } catch (err) {
          if (err.code === "auth/user-not-found") {
            try {
              setStatus("找不到帳號，自動註冊中...");
              await createUserWithEmailAndPassword(auth, email, password);
              setStatus("註冊完成！");
              window.location.href = getAfterLoginUrl();
            } catch (err2) {
              console.error("EMAIL SIGNUP ERROR", err2);
              setStatus("註冊失敗：" + (err2.message || ""));
            }
          } else {
            console.error("EMAIL LOGIN ERROR", err);
            setStatus("登入失敗：" + (err.message || ""));
          }
        }
      });
    }
  </script>
</body>
</html>