<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>好想租屋｜登入</title>
  <link rel="icon" type="image/png" href="logo.jpg" />
  <style>
    :root {
      --primary: #10b4c7; /* 蒂芬妮藍 */
      --primary-dark: #0f8798;
      --bg: #f4f6f9;
    }
    body {
      font-family: "Noto Sans TC", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    .login-box {
      background: #fff;
      padding: 32px 28px;
      border-radius: 16px;
      box-shadow: 0 6px 24px rgba(15,23,42,0.12);
      width: 360px;
      text-align: center;
    }
    h2 {
      margin-bottom: 8px;
      font-size: 20px;
    }
    p.subtitle {
      margin: 0 0 18px;
      font-size: 13px;
      color: #6b7280;
    }
    button {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border: none;
      border-radius: 999px;
      font-size: 15px;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    #btn-google { background-color: #4285F4; color: white; }
    #btn-line { background-color: #06C755; color: white; }
    #btn-email-toggle { background-color: #4b5563; color: white; }
    #btn-guest { background-color: #9ca3af; color: #fff; }
    #btn-phone { background-color: #f59e0b; color: #fff; }

    #email-section {
      display: none;
      margin-top: 14px;
      text-align: left;
    }
    input {
      width: 100%;
      padding: 9px 10px;
      margin: 5px 0;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }
    #status {
      margin-top: 14px;
      font-size: 13px;
      color: #374151;
      min-height: 1.4em;
    }
    .logo {
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div class="login-box">
    <img src="logo.jpg" alt="logo" width="64" class="logo">
    <h2>開始使用 好想租屋</h2>
    <p class="subtitle">請選擇登入方式，登入後可瀏覽更多功能。</p>

    <button id="btn-google">使用 Google 登入</button>
    <button id="btn-line">使用 LINE 登入</button>
    <button id="btn-email-toggle">使用電子郵件登入</button>

    <div id="email-section">
      <input id="email-input" type="email" placeholder="請輸入 Email">
      <input id="password-input" type="password" placeholder="請輸入密碼（至少 6 字）">
      <button id="btn-email-login">登入 / 註冊</button>
    </div>

    <button id="btn-guest">以訪客身分繼續</button>
    <button id="btn-phone">手機登入（即將開放）</button>

    <p id="status"></p>
  </div>

  <script type="module">
    import {
      GoogleAuthProvider,
      OAuthProvider,
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult,
      signInAnonymously,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    import { auth } from "./firebase-init.js";

    const AFTER_LOGIN_URL = "home.html"; // ✅ 登入後先回首頁

    const statusEl       = document.getElementById("status");
    const btnGoogle      = document.getElementById("btn-google");
    const btnLine        = document.getElementById("btn-line");
    const btnGuest       = document.getElementById("btn-guest");
    const btnPhone       = document.getElementById("btn-phone");
    const btnEmailToggle = document.getElementById("btn-email-toggle");
    const emailSection   = document.getElementById("email-section");
    const btnEmailLogin  = document.getElementById("btn-email-login");
    const emailInput     = document.getElementById("email-input");
    const passwordInput  = document.getElementById("password-input");

    const googleProvider = new GoogleAuthProvider();
    const lineProvider   = new OAuthProvider("oidc.oid.line");
    const isMobile = /iPhone|iPad|Android/i.test(navigator.userAgent);

    function setStatus(msg) {
      if (statusEl) statusEl.textContent = msg || "";
    }

    async function signInWithProviderPopup(provider, name) {
      try {
        setStatus(`使用 ${name} 登入中...`);
        await signInWithPopup(auth, provider);
        setStatus("登入成功，導向中...");
        window.location.href = AFTER_LOGIN_URL;
      } catch (err) {
        console.error(`${name} LOGIN ERROR`, err);
        setStatus(`${name} 登入失敗：${err.message || "未知錯誤"}`);
      }
    }

    // LINE redirect 回來處理（手機）
    getRedirectResult(auth)
      .then((result) => {
        if (result && result.user) {
          setStatus("登入成功，導向中...");
          window.location.href = AFTER_LOGIN_URL;
        }
      })
      .catch((err) => {
        if (err.code !== "auth/no-auth-event") {
          console.error("LINE redirect error", err);
        }
      });

    // Google
    btnGoogle?.addEventListener("click", () => {
      signInWithProviderPopup(googleProvider, "Google");
    });

    // LINE
    btnLine?.addEventListener("click", async () => {
      try {
        setStatus("正在開啟 LINE 登入…");
        if (isMobile) {
          await signInWithRedirect(auth, lineProvider);
        } else {
          await signInWithProviderPopup(lineProvider, "LINE");
        }
      } catch (err) {
        console.error("LINE LOGIN ERROR", err);
        setStatus("LINE 登入失敗：" + (err.message || ""));
      }
    });

    // 訪客
    btnGuest?.addEventListener("click", async () => {
      try {
        setStatus("以訪客身分登入中...");
        await signInAnonymously(auth);
        setStatus("登入成功，導向中...");
        window.location.href = AFTER_LOGIN_URL;
      } catch (err) {
        console.error("[GUEST ERROR]", err);
        setStatus("訪客登入失敗：" + err.message);
      }
    });

    // 手機登入（目前只提示）
    btnPhone?.addEventListener("click", () => {
      setStatus("目前僅開放 Google / LINE / Email 登入，手機登入即將推出。");
    });

    // Email 區塊開關
    if (btnEmailToggle && emailSection) {
      emailSection.style.display = "none";
      btnEmailToggle.addEventListener("click", () => {
        const visible = emailSection.style.display !== "none";
        emailSection.style.display = visible ? "none" : "block";
      });
    }

    // Email 登入 / 自動註冊
    btnEmailLogin?.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();

      if (!email || !password) {
        setStatus("請輸入 Email 與密碼。");
        return;
      }
      if (password.length < 6) {
        setStatus("密碼至少 6 個字。");
        return;
      }

      try {
        setStatus("Email 登入中...");
        await signInWithEmailAndPassword(auth, email, password);
        setStatus("登入成功！");
        window.location.href = AFTER_LOGIN_URL;
      } catch (err) {
        if (err.code === "auth/user-not-found") {
          try {
            setStatus("找不到帳號，自動註冊中...");
            await createUserWithEmailAndPassword(auth, email, password);
            setStatus("註冊完成！");
            window.location.href = AFTER_LOGIN_URL;
          } catch (err2) {
            console.error("EMAIL SIGNUP ERROR", err2);
            setStatus("註冊失敗：" + err2.message);
          }
        } else {
          console.error("EMAIL LOGIN ERROR", err);
          setStatus("登入失敗：" + err.message);
        }
      }
    });
  </script>
</body>
</html>